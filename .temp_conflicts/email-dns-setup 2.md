# SendGrid DNS Setup (SPF, DKIM, DMARC)
This guide documents domain authentication for multi-domain sending with SendGrid across:
- linkagevahub.com
- admin.linkagevahub.com
- esystemsmanagement.com

Purpose:
- Improve deliverability and trust (SPF/DKIM alignment)
- Satisfy DMARC policy and reporting
- Ensure “From” identities used by the platform are fully authenticated

Related code and endpoints
- Email domains mapping: [emailDomains.js](../../backend/config/emailDomains.js)
- Central config validation: [emailConfig.js](../../backend/config/emailConfig.js)
- SendGrid utility: [sendgrid.js](../../backend/utils/sendgrid.js)
- Email composition: [email.js](../../backend/utils/email.js)
- Non‑prod health endpoint: GET /api/internal/email/health
- Admin config checks: GET /api/email-test/config, POST /api/email-test/send

Sender identities (From)
- VA: hello@linkagevahub.com (linkagevahub.com)
- Business: hello@esystemsmanagement.com (esystemsmanagement.com)
- Admin: noreply@admin.linkagevahub.com (admin.linkagevahub.com)

1) Authenticate each domain in SendGrid
Perform for every domain: linkagevahub.com, admin.linkagevahub.com, esystemsmanagement.com

In SendGrid Dashboard:
- Settings → Sender Authentication → Authenticate Your Domain
- Select your DNS host, domain, and confirm that you want to brand links
- Choose “Use CNAME” (recommended)

SendGrid will provide three CNAME records per domain (examples shown with placeholders; use the exact values provided by SendGrid):
- emX.YOURDOMAIN → u12345678.wl123.sendgrid.net
- s1._domainkey.YOURDOMAIN → s1.domainkey.u12345678.wl123.sendgrid.net
- s2._domainkey.YOURDOMAIN → s2.domainkey.u12345678.wl123.sendgrid.net

Example placeholders (do not copy as-is; replace with your actual SendGrid values)
- linkagevahub.com
  - em1234.linkagevahub.com → u12345678.wl123.sendgrid.net
  - s1._domainkey.linkagevahub.com → s1.domainkey.u12345678.wl123.sendgrid.net
  - s2._domainkey.linkagevahub.com → s2.domainkey.u12345678.wl123.sendgrid.net

- admin.linkagevahub.com
  - em5678.admin.linkagevahub.com → u12345678.wl123.sendgrid.net
  - s1._domainkey.admin.linkagevahub.com → s1.domainkey.u12345678.wl123.sendgrid.net
  - s2._domainkey.admin.linkagevahub.com → s2.domainkey.u12345678.wl123.sendgrid.net

- esystemsmanagement.com
  - em9012.esystemsmanagement.com → u12345678.wl123.sendgrid.net
  - s1._domainkey.esystemsmanagement.com → s1.domainkey.u12345678.wl123.sendgrid.net
  - s2._domainkey.esystemsmanagement.com → s2.domainkey.u12345678.wl123.sendgrid.net

Notes:
- Do not alter the hostnames generated by SendGrid (the “emXXXX” prefix varies)
- TTL: 300–3600 seconds is typical
- After adding the records, click “Verify” in SendGrid. Verification may take several minutes to propagate.

2) SPF records
SPF should include SendGrid for the domain used as the envelope MAIL FROM / bounce domain. If you have an existing SPF record, append include:sendgrid.net rather than adding a second SPF TXT record.

Examples:
- If no SPF exists yet:
  - TXT @ (root): v=spf1 include:sendgrid.net ~all

- If SPF already exists (e.g., using Google Workspace):
  - TXT @ (root): v=spf1 include:_spf.google.com include:sendgrid.net ~all

Cautions:
- Only one SPF TXT record per hostname (merge includes)
- Use ~all initially; you may tighten to -all after auditing

3) DMARC policy
Add a DMARC record for each domain. Start with a monitoring policy (p=none) to gather reports, then later move to quarantine/reject.

TXT _dmarc.YOURDOMAIN:
- v=DMARC1; p=none; rua=mailto:dmarc@YOURDOMAIN; ruf=mailto:dmarc@YOURDOMAIN; fo=1; adkim=r; aspf=r; pct=100

After monitoring (2–4 weeks), consider:
- p=quarantine (or p=reject) once alignment passes for SPF/DKIM
- adkim/aspf can be set to s (strict) if you want strict alignment

4) Verify alignment (From domain and DKIM)
- Ensure the “From” being used by services matches the authenticated domain:
  - linkage-va-hub-api → EMAIL_FROM=hello@linkagevahub.com
  - esystems-backend → EMAIL_FROM=hello@esystemsmanagement.com
  - admin-backend → EMAIL_FROM=noreply@admin.linkagevahub.com

Render services alignment:
- In Render for each backend service, confirm:
  - SENDGRID_API_KEY is set (per service)
  - EMAIL_FROM set to the above sender for that service
  - Optionally SENDGRID_SANDBOX=true in non‑production for safe config testing

5) Health checks and smoke tests
Non‑prod (no delivery):
- Ensure SENDGRID_SANDBOX=true
- GET /api/internal/email/health should return success, config details, and sender selections
- GET /api/email-test/config to view domain/sender configs
- POST /api/email-test/send with skipActualSend=true (default) validates flows without sending

Staging (live send with real keys):
- POST /api/email-test/send with skipActualSend=false and a test recipient you control
- Expect 202 Accepted from SendGrid, correct From header domain, and categories containing:
  - brand domain (linkagevahub.com, admin.linkagevahub.com, esystemsmanagement.com)
  - template name (e.g., new-message)
  - recipient type (va, business, admin)
- In SendGrid → Activity, verify events and mail settings

6) Troubleshooting checklist
- DKIM fails: Ensure both s1 and s2 CNAMEs exist and match SendGrid’s provided targets
- SPF fails: Ensure only one SPF record exists; merge multiple includes into a single TXT
- DMARC failure: Check alignment. “From” must be an authenticated domain; categories/logs are emitted in [sendgrid.js](../../backend/utils/sendgrid.js)
- Production startup fails: [server.js](../../backend/server.js) calls ensureEmailProdConfig(); resolve errors reported by [emailConfig.js](../../backend/config/emailConfig.js)

Appendix: Quick reference records (placeholders)
- TXT @: v=spf1 include:sendgrid.net ~all
- TXT _dmarc: v=DMARC1; p=none; rua=mailto:dmarc@YOURDOMAIN; ruf=mailto:dmarc@YOURDOMAIN; fo=1; adkim=r; aspf=r; pct=100
- CNAME emXXXX.YOURDOMAIN → uXXXXXXXX.wlXXX.sendgrid.net
- CNAME s1._domainkey.YOURDOMAIN → s1.domainkey.uXXXXXXXX.wlXXX.sendgrid.net
- CNAME s2._domainkey.YOURDOMAIN → s2.domainkey.uXXXXXXXX.wlXXX.sendgrid.net